name: Enforce PR Assignment

on:
  pull_request_target:
    types: [opened, reopened]

permissions:
  pull-requests: write
  issues: read

jobs:
  check-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Check issue assignment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prAuthor = pr.user.login;
            const prNumber = pr.number;
            const body = pr.body || '';

            console.log(`Checking PR #${prNumber} by @${prAuthor}`);

            // Check if the PR author is an admin or maintainer (exempt)
            const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: prAuthor,
            });

            const permission = permissionLevel.permission;
            console.log(`@${prAuthor} has '${permission}' permission`);

            if (permission === 'admin' || permission === 'maintain') {
              console.log('PR author is admin/maintainer â€” skipping check.');
              return;
            }

            // Extract issue numbers from the PR body
            // Matches: Closes #123, Fixes #456, Resolves #789 (case-insensitive)
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const issueNumbers = [];
            let match;
            while ((match = issuePattern.exec(body)) !== null) {
              issueNumbers.push(parseInt(match[1], 10));
            }

            if (issueNumbers.length === 0) {
              console.log('No linked issues found in PR body â€” allowing through.');
              return;
            }

            console.log(`Found linked issues: ${issueNumbers.join(', ')}`);

            // Check each linked issue for assignees
            for (const issueNumber of issueNumbers) {
              let issue;
              try {
                const { data } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                });
                issue = data;
              } catch (error) {
                console.log(`Could not fetch issue #${issueNumber} â€” skipping.`);
                continue;
              }

              const assignees = issue.assignees.map(a => a.login);

              if (assignees.length === 0) {
                console.log(`Issue #${issueNumber} is unassigned â€” allowing through.`);
                continue;
              }

              console.log(`Issue #${issueNumber} is assigned to: ${assignees.join(', ')}`);

              if (!assignees.includes(prAuthor)) {
                const assigneeMentions = assignees.map(a => `@${a}`).join(', ');

                // Close the PR with a helpful comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `ðŸ‘‹ Hi @${prAuthor}, thanks for your interest in contributing!\n\nHowever, issue #${issueNumber} is currently assigned to ${assigneeMentions}. To avoid duplicate work, this PR has been automatically closed.\n\nIf you'd like to work on this issue, please:\n1. Comment on the issue asking to be assigned\n2. Wait for a maintainer to assign you\n3. Then open a new PR\n\nWe appreciate your enthusiasm and look forward to your contributions! ðŸ™Œ`,
                });

                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  state: 'closed',
                });

                console.log(`Closed PR #${prNumber} â€” author is not an assignee of issue #${issueNumber}.`);
                return;
              }

              console.log(`@${prAuthor} is an assignee of issue #${issueNumber} â€” allowed.`);
            }

            console.log('All checks passed â€” PR is allowed.');
